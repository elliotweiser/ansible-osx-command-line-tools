---
# tasks file for ansible-osx-command-line-tools

- name: Am I running on Mac OS X?
  assert:
    that: ansible_distribution == 'MacOSX'
    msg: Target host is not running Mac OS X

- name: Remove existing Command Line Tools installation
  file:
    path: '{{ osx_clt_path }}'
    state: absent
  when: osx_clt_force_install
  become: yes

- name: Check that the Command Line Tools path is present
  stat:
    path: '{{ osx_clt_path }}'
  register: osx_clt_stat

- name: Is the C++ compiler useable?
  command: g++ --version
  register: osx_clt_compiler
  check_mode: no
  ignore_errors: true
  changed_when: false

- name: Check the Command Line Tools package metadata
  command: pkgutil --pkg-info=com.apple.pkg.CLTools_Executables
  register: osx_clt_pkg_info
  check_mode: no
  ignore_errors: true
  changed_when: false

- block:
    - name: Prepare to install Command Line Tools
      file:
        path: '{{ osx_clt_tmp_file }}'
        state: touch

    - name: Check for Command Line Tools in Software Update list
      shell: >
        set -o pipefail;
        /usr/sbin/softwareupdate -l |
        grep -B 1 -E 'Command Line Tools' |
        awk -F'*' '/^ +\*/ {print $2}' |
        sed 's/^ *//' |
        grep -iE '[0-9|.]' |
        sort |
        tail -n1
      args:
        executable: /bin/bash
      register: osx_clt_su_list
      changed_when: false
      failed_when: osx_clt_su_list.rc != 0 or osx_clt_su_list.stdout|length == 0

    - name: Install Command Line Tools
      command: /usr/sbin/softwareupdate -i '{{ osx_clt_su_list.stdout }}'
      notify:
        - Cleanup
      register: osx_clt_su_result
      failed_when: >-
        osx_clt_su_result.rc != 0 or
        'Error installing updates.' in osx_clt_su_result.stdout
  when: >-
    osx_clt_pkg_info.rc != 0 or
    osx_clt_compiler.rc != 0 or
    not osx_clt_stat.stat.exists or
    (osx_clt_force_install | bool)
